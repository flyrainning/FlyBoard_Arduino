# FBCmd

### 功能

FBCmd提供了一个简单的串口交互式命令行接口

可以实现人机命令行交互或设备与设备间的串口通讯

#### 特点

- 定义标准的命令结构，支持接收命令和应答
- 支持自定义设备地址，支持一对一，一对多，多对一通讯，支持广播
- 可以通过插件扩展命令集，也可添加自定义命令
- 支持参数传递
- 支持命令应答回调
- 支持CRC校验

### 依赖

- FBSettings
- FBSerial

### 可选配置

```
  //单条命令的最大长度
  #define CMD_BUFFER_MAX  128 //max buffer

  //命令头标识符
  #define CMD_TYPE_SYN '-'

  //应答头标识符
  #define CMD_TYPE_ACK '+'

  //命令结束标识符
  #define CMD_FLAG_END ';'
```

### 命令发送与接受

命令帧与应答帧采用相同的格式

`<type>[{id}][target_address:][source_address:]cmd([data])[:crc];`

|      位置      | 必须 |              说明              |     取值范围      |                   备注                    |
| -------------- | ---- | ------------------------------ | ----------------- | ----------------------------------------- |
| type           | 必选 | 通讯类型，标示命令或应答       | SYN ACK           | 可以通过CMD_TYPE_SYN 和 CMD_TYPE_ACK 设置 |
| id             | 可选 | 命令id，可防止命令重复执行     | uint16_t 0-65535  |                                           |
| target_address | 可选 | 目标地址                       | 4Byte  默认"0000" | "0000" 为广播地址                         |
| source_address | 可选 | 源地址，应答帧将使用此地址应答 | 4Byte  默认"0000" | "0000" 为广播地址                         |
| cmd            | 必选 | 命令                           |                   |                                           |
| data           | 可选 | 参数，传递到命令函数中         | String类型        |                                           |
| crc            | 可选 | crc16                          | 16bit HEX         | 如果存在，则校验，失败直接丢弃            |


#### 示例

命令：

- -{25}C001:A001:switch1(on):3649;
- -0000:0000:cmd1(data);
- -cmd2(data);
- -cmd3();

应答：
- +0000:0000:cmd1(data);
- +A001:C001:switch1(on);

#### 规则

- 命令帧包含{id}，则应答帧也包含{id}，值为id+1
- 命令或应答如果包含crc，则crc校验失败自动丢弃
- 地址为空默认自动填充为广播地址
- 命令帧中不能再包含 - + ; 等关键字符

例：
发送命令 `-{25}C001:A001:switch1(on):3649;`
表示由本机（地址A001）向目标（地址C001）发送命令 switch1 ，传递参数 on

目标设备执行switch1命令后返回应答`+{26}A001:C001:switch1(is on):955E;`
表示发送给A001的对于命令switch1的应答，结果为is on

收到命令帧，会调用命令对应的执行函数
收到应答帧，会调用命令对应的回调函数，回调函数常用于设备间通讯，发送查询指令后接收并处理结果


### 配置
